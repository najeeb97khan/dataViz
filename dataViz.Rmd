---
title: "dataViz"
author: "Najeeb Khan, Hafik Arhan, Swaraj Oturkar, Elif Erbil"
date: "12/4/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'C:\\Users\\Swaraj\\Documents\\TUM\\Data Analysis and Visualisation in R')

```

### Getting Data 
```{r echo=FALSE, include=FALSE}
library(data.table)
library(knitr)
library(ggplot2)
library(reshape)
```
```{r echo=TRUE}
genotype_file <- 'Data/eqtl/genotype.txt'
growth_file <- 'Data/eqtl/growth.txt'
gene_file <- 'Data/eqtl/gene.txt'
marker_file <- 'Data/eqtl/marker.txt'

genotype <- as.data.table(read.delim(genotype_file))
growth <- as.data.table(read.delim(growth_file))
gene <- as.data.table(read.delim(gene_file))
marker <- as.data.table(read.delim(marker_file))

```
### Checking the integrity of the data in both of the tables

```{r echo=TRUE}
## Genotype Data
names <- c("strain")
for(i in 1:1000)
{
  names <- c(names, paste("mrk", i, sep = "_"))
}
colnames(genotype) <- names

### Calculating the proportion of Wild Isolate and Lab Strain
genotype[, labProp := apply(genotype, MARGIN = 1, FUN = function(row) mean(grepl(unname(unlist(row)), pattern = 'Lab strain')))]

genotype[, wildProp := apply(genotype, MARGIN = 1, FUN = function(row) mean(grepl(unname(unlist(row)), pattern = 'Wild isolate')))]

## Growth Data

### Checking the column class
sapply(growth, class)

### Melting the data to make it tidy
growth_melt <- melt(growth, id.vars = 'strain', variable.name = 'env', value.name = 'rate')
genotype_melt <- melt(genotype, id.vars = 'strain', variable.name = 'marker', value.name = 'genotype')
genotype_melt[,marker:=gsub("mrk_","",marker)]
### Plotting boxplots to recognize any outliers
ggplot(growth_melt, aes(env, rate)) + geom_boxplot() + theme_minimal() +
  labs(title = "Visualisation of Growth Data") +
  xlab("Environment") +
  ylab("Rate of Growth")

```

### Getting insight into how proportion of each parent strain effects the growth
We investigate how the proportion of parent strain (from Wild Isolate and Lab Strain) is responsible for effecting the growth in a particular medium.

```{r echo=TRUE}
## Merging the two datasets on the basis of segregants
growth_geno <- merge(genotype[, c(1, 1002, 1003)], growth)
geno_growth <- merge(genotype_melt, growth)
gene_marker <- merge(marker,gene,by = "chrom",allow.cartesian = T)
setnames(gene_marker,"start.x", "marker_start")
setnames(gene_marker,"start.y", "gene_start")
setnames(gene_marker,"end.x", "marker_end")
setnames(gene_marker,"end.y", "gene_end")


## Melting the merged table
growth_geno_melt <- melt(growth_geno, id.vars = c('strain', 'labProp', 'wildProp'), variable.name = 'env', value.name = 'rate')
geno_growth_melt <- melt(geno_growth, id.vars = c("strain","marker","genotype"), variable.name = "env", value.name = "rate")

##Finding those markers which are on gene either completely or partially
gene_marker_filtered <- subset(gene_marker,!(marker_start>gene_end | marker_end < gene_start))



## PLotting the data points as barplot distributed over environments
ggplot(growth_geno_melt, aes(x = wildProp, y=rate)) + geom_point() + theme_minimal() +
  facet_wrap(~env)

ggplot(growth_geno_melt, aes(x = labProp, y=rate)) + geom_point() + theme_minimal() +
  facet_wrap(~env)
## An insight into growth in different strains segregated by genotype (Lab Strain or Wild Isolate)

ggplot(geno_growth_melt, aes(x = marker, y=rate, color=genotype)) + geom_point() + theme_minimal() +facet_wrap(~env)

```